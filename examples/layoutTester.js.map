{"version":3,"file":"layoutTester.js","sources":["../../../examples/src/layoutTester.ts"],"sourcesContent":["import {html, render} from 'lit-html';\nimport Tweakpane from 'tweakpane';\nimport {GraferController} from '../../src/grafer/GraferController';\nimport {DataFile} from '@dekkai/data-source/build/lib/file/DataFile';\n\ninterface LayoutInfo {\n    clusters: string;\n    clustersFile: File;\n    nodes: string;\n    nodesFile: File;\n    nodeEdges: string;\n    nodeEdgesFile: File;\n}\n\nasync function parseJSONL(input, cb): Promise<void> {\n    const file = await DataFile.fromLocalSource(input);\n\n    // load 16MB chunks\n    const sizeOf16MB = 16 * 1024 * 1024;\n    const byteLength = file.byteLength;\n    const decoder = new TextDecoder();\n    const lineBreak = '\\n'.charCodeAt(0);\n\n    for(let offset = 0; offset <= byteLength; offset += sizeOf16MB) {\n        const chunkEnd = Math.min(offset + sizeOf16MB, byteLength);\n        const chunk = await file.loadData(offset, chunkEnd);\n        const view = new DataView(chunk);\n        let start = 0;\n        for (let i = 0, n = chunk.byteLength; i < n; ++i) {\n            if (view.getUint8(i) === lineBreak || offset + i === byteLength) {\n                const statementBuffer = new Uint8Array(chunk, start, i - start);\n                start = i + 1;\n\n                const str = decoder.decode(statementBuffer);\n                const json = JSON.parse(str);\n\n                cb(json);\n            }\n        }\n\n        if (start < chunk.byteLength) {\n            offset -= chunk.byteLength - start;\n        }\n\n        // console.log(`${chunkEnd} / ${byteLength} - ${((chunkEnd/byteLength) * 100).toFixed(2)}%`);\n    }\n}\n\nfunction createFileInput(cb: () => void): HTMLInputElement {\n    const input = document.createElement('input');\n    input.type = 'file';\n    input.multiple = false;\n    input.addEventListener('change', cb);\n    return input;\n}\n\nfunction renderMenu(container: HTMLElement, cb: (result: LayoutInfo) => void): void {\n    render(html`<div id=\"menu\" class=\"start_menu\"></div>`, container);\n\n    const result: LayoutInfo = {\n        clusters: 'No file selected.',\n        clustersFile: null,\n        nodes: 'No file selected.',\n        nodesFile: null,\n        nodeEdges: 'No file selected.',\n        nodeEdgesFile: null,\n    };\n\n    const menu = new Tweakpane({\n        title: 'Grafer Loader',\n        container: document.querySelector('#menu'),\n    });\n\n    const clustersInput = createFileInput(() => {\n        if (clustersInput.files.length) {\n            result.clustersFile = clustersInput.files[0];\n            result.clusters = result.clustersFile.name;\n        } else {\n            result.clusters = 'No file selected.';\n            result.clustersFile = null;\n        }\n    });\n    menu.addMonitor(result, 'clusters');\n    menu.addButton({ title: 'browse...' }).on('click', () => clustersInput.click());\n\n    const nodesInput = createFileInput(() => {\n        if (nodesInput.files.length) {\n            result.nodesFile = nodesInput.files[0];\n            result.nodes = result.nodesFile.name;\n        } else {\n            result.nodes = 'No file selected.';\n            result.nodesFile = null;\n        }\n    });\n    menu.addMonitor(result, 'nodes');\n    menu.addButton({ title: 'browse...' }).on('click', () => nodesInput.click());\n\n    const nodeEdgesInput = createFileInput(() => {\n        if (nodeEdgesInput.files.length) {\n            result.nodeEdgesFile = nodeEdgesInput.files[0];\n            result.nodeEdges = result.nodeEdgesFile.name;\n        } else {\n            result.nodeEdges = 'No file selected.';\n            result.nodeEdgesFile = null;\n        }\n    });\n    menu.addMonitor(result, 'nodeEdges');\n    menu.addButton({ title: 'browse...' }).on('click', () => nodeEdgesInput.click());\n\n    const loadBtn = menu.addButton({ title: 'load' });\n    loadBtn.on('click', () => {\n        cb(result);\n    });\n}\n\nasync function loadGraph(container: HTMLElement, info: LayoutInfo): Promise<void> {\n    if (info.clustersFile || info.nodesFile) {\n        render(html`<canvas class=\"grafer_container\"></canvas><mouse-interactions></mouse-interactions>`, container);\n\n        const canvas = document.querySelector('.grafer_container') as HTMLCanvasElement;\n        const layers = [];\n\n        if (info.clustersFile) {\n            const nodes = {\n                type: 'Ring',\n                data: [],\n            };\n            await parseJSONL(info.clustersFile, json => {\n                nodes.data.push({\n                    id: json.id,\n                    x: json.x,\n                    y: json.y,\n                    z: json.z || 0,\n                    radius: json.size,\n                    color: 0,\n                });\n            });\n\n            const edges = {\n                data: [],\n            };\n\n            layers.push({ nodes, edges });\n        }\n\n        if (info.nodesFile) {\n            const nodes = {\n                type: 'Circle',\n                data: [],\n            };\n            await parseJSONL(info.nodesFile, json => {\n                nodes.data.push({\n                    id: json.id,\n                    x: json.x,\n                    y: json.y,\n                    z: json.z || 0,\n                    radius: json.size,\n                    color: 2,\n                });\n            });\n\n            const edges = {\n                data: [],\n                options: {\n                    alpha: 0.75,\n                    nearDepth: 0.9,\n                },\n            };\n\n            if (info.nodeEdgesFile) {\n                await parseJSONL(info.nodeEdgesFile, json => {\n                    edges.data.push(Object.assign({}, json, {\n                        sourceColor: 3,\n                        targetColor: 3,\n                    }));\n                });\n            }\n\n            layers.push({ nodes, edges });\n        }\n\n        const colors = [\n            '#5e81ac',\n            '#88c0d0',\n            '#d8dee9',\n            '#4c566a',\n        ];\n\n        new GraferController(canvas, { colors, layers });\n    }\n}\n\nexport async function layoutTester(container: HTMLElement): Promise<void> {\n    renderMenu(container, result => {\n        loadGraph(container, result);\n    });\n}\n"],"names":[],"mappings":"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"}